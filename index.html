<!doctype html>
<html lang="en" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Crucible — PNG Pages with Hover Translations</title>
<style>
  :root { --bar: 48px; }
  html, body { height:100%; margin:0; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f4f5f7; }
  #topbar {
    position: sticky; top:0; z-index:1000; display:flex; gap:8px; align-items:center;
    height: var(--bar); padding: 8px 12px; background:#fff; box-shadow: 0 1px 6px rgba(0,0,0,.08);
  }
  #status { margin-left:auto; font-size:12px; color:#666; }

  #pages {
    position:absolute; inset: var(--bar) 0 0 0;
    overflow:auto; padding: 12px 0 24px;
  }

  .page {
    position: relative;
    width: min(100%, 1600px);     /* cap max width if you like */
    margin: 16px auto;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
  }

  .page img.page-img {
    display:block;
    width: 100%;     /* fit-to-window width */
    height: auto;    /* keep aspect ratio */
  }

  /* Overlay rectangles */
  .gloss-box {
    position:absolute;
    outline: 2px solid rgba(255,220,80,0);
    border-radius: 4px;
    cursor: help;
    background: transparent;
    transition: outline-color 120ms ease;
  }
  .gloss-box:hover { outline-color: rgba(255,220,80,0.9); }

  /* Tooltip bubble */
  .gloss-tip {
    position:fixed; max-width:420px; background:#111; color:#fff; padding:8px 10px; border-radius:6px;
    font:14px/1.35 system-ui; pointer-events:none; z-index:99999; box-shadow:0 8px 22px rgba(0,0,0,.35); display:none;
  }
</style>
</head>
<body>
  <div id="topbar">
    <strong>The Crucible — Hover Translations (PNG)</strong>
    <span id="status"></span>
  </div>

  <div id="pages"></div>
  <div id="tooltip" class="gloss-tip"></div>

<script>
const JSON_PATH = 'translation.json';           // your overlay manifest
const DEFAULT_IMAGE_PATTERN = (n) => `images/page-${n}.png`; // fallback if pageImages not provided

const pagesEl = document.getElementById('pages');
const statusEl = document.getElementById('status');
const tipEl    = document.getElementById('tooltip');

let manifest = { pages:{}, pageImages:{} };

function setStatus(msg){ statusEl.textContent = msg; }
function showTip(text, x, y){
  if (!text) return;
  tipEl.textContent = text;
  tipEl.style.left = (x + 12) + 'px';
  tipEl.style.top  = (y + 12) + 'px';
  tipEl.style.display = 'block';
}
function hideTip(){ tipEl.style.display = 'none'; }

// Build one page block: <div.page> with <img> and overlays
function buildPage(pageNum, imgSrc) {
  const pageDiv = document.createElement('div');
  pageDiv.className = 'page';
  pageDiv.dataset.pageNumber = String(pageNum);

  const img = document.createElement('img');
  img.className = 'page-img';
  img.alt = `Page ${pageNum}`;
  img.loading = 'lazy';
  img.src = imgSrc;

  // overlays container is the pageDiv itself (absolute children over the img)
  pageDiv.appendChild(img);
  pagesEl.appendChild(pageDiv);

  // When the image loads (or resizes), (re)draw overlays at correct size
  img.addEventListener('load', () => drawOverlaysForPage(pageNum));
  // keep overlays perfect on container resizes
  if ('ResizeObserver' in window) {
    const ro = new ResizeObserver(() => drawOverlaysForPage(pageNum));
    ro.observe(pageDiv);
  }
}

// Clear overlays for a page
function clearOverlays(pageNum){
  const page = pagesEl.querySelector('.page[data-page-number="' + pageNum + '"]');
  if (!page) return;
  page.querySelectorAll('.gloss-box').forEach(el => el.remove());
}

// Draw overlays based on percent coords in manifest
function drawOverlaysForPage(pageNum){
  const page = pagesEl.querySelector('.page[data-page-number="' + pageNum + '"]');
  if (!page) return;
  const img = page.querySelector('img.page-img');
  if (!img || !img.naturalWidth || !img.naturalHeight) return;

  clearOverlays(pageNum);

  const boxes = (manifest.pages && manifest.pages[String(pageNum)]) ? manifest.pages[String(pageNum)] : [];
  if (!boxes.length) return;

  // The absolutely positioned overlays align to the size of the displayed image,
  // which is the pageDiv's content box (same as img width since img is 100%).
  const w = page.clientWidth;
  // maintain the same aspect ratio as the image to compute height
  const h = w * (img.naturalHeight / img.naturalWidth);

  // keep the page div height synced to prevent overlap
  page.style.height = h + 'px';

  for (let i=0;i<boxes.length;i++){
    const b = boxes[i];
    const el = document.createElement('div');
    el.className = 'gloss-box';
    el.style.left   = (b.x * w) + 'px';
    el.style.top    = (b.y * h) + 'px';
    el.style.width  = (b.w * w) + 'px';
    el.style.height = (b.h * h) + 'px';
    const tip = b.en || '';
    el.title = tip; // native fallback
    el.addEventListener('mousemove', (ev)=> showTip(tip, ev.clientX, ev.clientY));
    el.addEventListener('mouseleave', hideTip);
    page.appendChild(el);
  }
}

// Load manifest and build pages
async function boot(){
  setStatus('Loading translation.json…');
  try {
    const res = await fetch(JSON_PATH);
    if (!res.ok) throw new Error('JSON ' + res.status);
    manifest = await res.json();
  } catch (e) {
    console.error(e);
    setStatus('Could not load translation.json (see console).');
    return;
  }

  // Decide page list & images
  // Option 1 (recommended): manifest.pageImages = { "1":"images/pg1.png", "2":"images/pg2.png", ... }
  // Option 2 (fallback): infer 1..N from keys in manifest.pages and use DEFAULT_IMAGE_PATTERN
  const pageNums = Object.keys(manifest.pages || {}).map(Number).sort((a,b)=>a-b);
  const imgMap = manifest.pageImages || {};

  for (const n of pageNums) {
    const src = imgMap[String(n)] || DEFAULT_IMAGE_PATTERN(n);
    buildPage(n, src);
  }

  setStatus('Loaded ' + pageNums.length + ' pages');
}

// Keep overlays aligned while resizing window
window.addEventListener('resize', () => {
  // redraw only currently rendered pages (all .page nodes)
  document.querySelectorAll('.page').forEach(pg => {
    const n = Number(pg.dataset.pageNumber);
    drawOverlaysForPage(n);
  });
});

// Start
boot();
</script>
</body>
</html>
